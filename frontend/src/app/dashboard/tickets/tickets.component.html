<!-- DASHBOARD PRINCIPAL -->
<mat-toolbar color="primary">
  Panel de Control - Municipalidad de San Román
</mat-toolbar>

<div class="dashboard-container">

  <h2 class="titulo">Resumen General</h2>

  <!-- TARJETAS PRINCIPALES -->
  <div class="stats-grid">
    <mat-card class="stat-card azul">
      <mat-card-title>Tickets Nuevos</mat-card-title>
      <mat-card-content>{{ resumen.nuevos }}</mat-card-content>
    </mat-card>

    <mat-card class="stat-card azul-oscuro">
      <mat-card-title>Tiempo promedio de solución</mat-card-title>
      <mat-card-content>{{ resumen.promedioSolucion }}</mat-card-content>
    </mat-card>

    <mat-card class="stat-card amarillo">
      <mat-card-title>Tickets resueltos hoy</mat-card-title>
      <mat-card-content>{{ resumen.resueltosHoy }}</mat-card-content>
    </mat-card>

    <mat-card class="stat-card gris">
      <mat-card-title>Total de Tickets</mat-card-title>
      <mat-card-content>{{ resumen.total }}</mat-card-content>
    </mat-card>
  </div>

  <!-- GRÁFICOS -->
  <div class="charts-grid">
    <mat-card class="chart-card">
      <mat-card-title>Tickets por Estado</mat-card-title>
      <mat-card-content>
        <canvas *ngIf="pieChartData"
          baseChart
          [data]="pieChartData"
          [options]="pieChartOptions"
          [type]="'pie'">
        </canvas>
      </mat-card-content>
    </mat-card>

    <mat-card class="chart-card">
      <mat-card-title>Evolución de Tickets por Mes</mat-card-title>
      <mat-card-content>
        <canvas *ngIf="lineChartData && lineChartData.datasets && lineChartData.datasets.length > 0"
          baseChart
          [data]="lineChartData"
          [options]="lineChartOptions"
          [type]="'line'">
        </canvas>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Botón de reporte (solo admin) -->
  <div class="text-center mt-4">
    <button mat-raised-button color="primary" *ngIf="authService.tieneRol('admin')" (click)="abrirModal()">
      Generar Reporte
    </button>
  </div>

</div>

<!-- MODAL GENERAR REPORTE -->
<mat-dialog-content *ngIf="modalAbierto">
  <mat-card class="modal-card">

    <mat-card-header>
      <mat-card-title>Generar Reporte</mat-card-title>
      <button mat-icon-button (click)="cerrarModal()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-card-header>

    <!-- Tabs PDF / Excel -->
    <mat-tab-group [(selectedIndex)]="tabActivaIndex">
      <mat-tab label="PDF">
        <div class="filtros">
          <mat-form-field appearance="fill">
            <mat-label>Fecha inicial</mat-label>
            <input matInput type="date" [(ngModel)]="filtros.fechaInicio">
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Fecha final</mat-label>
            <input matInput type="date" [(ngModel)]="filtros.fechaFin">
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Oficina (opcional)</mat-label>
            <mat-select [(ngModel)]="usuario.idOficina">
              <mat-option value="Todos">Todos</mat-option>
              <mat-option *ngFor="let o of oficinas" [value]="o.idOficina">{{ o.nombreOficina }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <button mat-raised-button color="primary" (click)="generarPdf(oficinaSeleccionada)">
          Descargar PDF
        </button>
      </mat-tab>

      <mat-tab label="Excel">
        <div class="filtros">
          <mat-form-field appearance="fill">
            <mat-label>Fecha inicial</mat-label>
            <input matInput type="date" [(ngModel)]="filtros.fechaInicio">
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Fecha final</mat-label>
            <input matInput type="date" [(ngModel)]="filtros.fechaFin">
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Oficina (opcional)</mat-label>
            <mat-select [(ngModel)]="usuario.idOficina">
              <mat-option value="">Todas</mat-option>
              <mat-option *ngFor="let o of oficinas" [value]="o.idOficina">{{ o.nombreOficina }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <button mat-raised-button color="accent" (click)="generarExcel(oficinaSeleccionada)">
          Descargar Excel
        </button>
      </mat-tab>
    </mat-tab-group>

  </mat-card>
</mat-dialog-content>
