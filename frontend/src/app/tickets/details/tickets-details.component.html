<div class="det-container" *ngIf="!loading && ticket">

  <!-- Encabezado -->
  <div class="header-section">
    <button class="btn-volver" (click)="volver()">â¬… Volver</button>
    <h2 class="det-title">Detalles del Ticket #{{ ticket.idTicket }}</h2>
  </div>

  <!-- InformaciÃ³n del Ticket -->
  <div class="info-grid">
    <div class="info-card">
      <label>Tipo de problema</label>
      <div class="info-value">{{ ticket.nombreCategoria }}</div>
    </div>

    <div class="info-card">
      <label>Nivel del incidente</label>
      <div class="info-value priority">{{ ticket.nombrePrioridad }}</div>
    </div>
  </div>

  <!-- Agregar Nuevo Comentario -->
  <div class="comment-form-section">
    <h3 class="section-title">Agregar Comentario</h3>
    <div class="comment-form">
      <textarea [(ngModel)]="nuevoComentario" placeholder="Escribe tu comentario aquÃ­..." rows="3"
        class="comment-textarea" [disabled]="enviandoComentario"></textarea>
      <button class="btn-submit-comment" (click)="agregarComentario()"
        [disabled]="!nuevoComentario.trim() || enviandoComentario">
        <span *ngIf="!enviandoComentario">ğŸ“ Agregar Comentario</span>
        <span *ngIf="enviandoComentario">Enviando...</span>
      </button>
    </div>
  </div>

  <!-- Historial del Ticket -->
  <div class="timeline-section">
    <div class="timeline-header">
      <h3 class="timeline-title">Historial del ticket</h3>

      <!-- Filtros -->
      <div class="filter-buttons">
        <button class="filter-btn" [class.active]="filtroActivo === 'todos'" (click)="cambiarFiltro('todos')">
          ğŸ“‹ Todos ({{ historial.length }})
        </button>
        <button class="filter-btn" [class.active]="filtroActivo === 'comentario'" (click)="cambiarFiltro('comentario')">
          ğŸ’¬ Comentarios
        </button>
        <button class="filter-btn" [class.active]="filtroActivo === 'observacion'"
          (click)="cambiarFiltro('observacion')">
          ğŸ“ Observaciones
        </button>
      </div>
    </div>

    <div class="timeline" *ngIf="historialFiltrado.length > 0; else noHistorial">
      <div class="timeline-item" *ngFor="let item of historialFiltrado; let i = index">
        <div class="timeline-date">
          <div class="date-box">
            <div class="month">{{ item.fechaCreacion | date:'MMM' }}</div>
            <div class="day">{{ item.fechaCreacion | date:'dd' }}</div>
            <div class="year">{{ item.fechaCreacion | date:'yyyy' }}</div>
          </div>
        </div>

        <div class="timeline-line">
          <div class="timeline-dot"></div>
          <div class="timeline-connector" *ngIf="i < historialFiltrado.length - 1"></div>
        </div>

        <div class="timeline-content">
          <div class="timeline-badge" [ngClass]="getBadgeClass(item.tipo)">
            {{ item.fechaCreacion | date:'HH:mm' }}
          </div>
          <div class="timeline-card">
            <h4 class="timeline-status">{{ getStatusTitle(item.tipo) }}</h4>
            <p class="timeline-description">{{ item.contenido }}</p>

            <!-- Archivos Adjuntos -->
            <div class="attachments" *ngIf="item.adjunto">
              <div class="attachment-label">ğŸ“ Archivos adjuntos:</div>
              <div class="attachment-list">
                <a *ngFor="let archivo of item.adjunto.split(',')" [href]="'http://localhost:3000/uploads/' + archivo"
                  target="_blank" class="attachment-link">
                  ğŸ“„ {{ archivo }}
                </a>
              </div>
            </div>

            <div class="timeline-author" *ngIf="item.nombres">
              {{ item.nombres }} {{ item.apellidos }}
              <span class="author-role" *ngIf="item.nombreRol">({{ item.nombreRol }})</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noHistorial>
      <p class="no-historial">
        {{ filtroActivo === 'todos' ? 'No hay historial disponible para este ticket.' : 'No hay ' + (filtroActivo ===
        'comentario' ? 'comentarios' : 'observaciones') + ' disponibles.' }}
      </p>
    </ng-template>
  </div>

  <!-- Herramientas -->
  <div class="det-card" *ngIf="herramientas.length > 0">
    <h3>Herramientas usadas</h3>
    <div>
      <ul class="herr-list">
        <li *ngFor="let h of herramientas">ğŸ›  {{ h }}</li>
      </ul>
    </div>
  </div>

  <!-- Acciones de estado -->
  <div class="acciones">
    <button class="btn pend" (click)="cambiarEstado(3)">Pendiente</button>
    <button class="btn res" (click)="cambiarEstado(4)">Resuelto</button>
    <button class="btn cerr" (click)="cambiarEstado(0)">Cerrado</button>
  </div>

</div>

<div *ngIf="loading" class="loading">
  Cargando ticket...
</div>