<div class="det-container" *ngIf="!loading && ticket">

  <!-- Encabezado -->
  <div class="header-section">
    <button class="btn-volver" (click)="volver()">
      <mat-icon>arrow_back</mat-icon> Volver
    </button>
    <div class="title-group">
      <h2 class="det-title">Ticket #{{ ticket.idTicket }}</h2>
      <span class="status-badge" [ngClass]="'status-' + ticket.idEstado">
        {{ ticket.nombreEstado }}
      </span>
    </div>
  </div>

  <!-- Información del Ticket -->
  <div class="info-grid">
    <div class="info-card">
      <label>Título</label>
      <div class="info-value">{{ ticket.tituloTicket }}</div>
    </div>

    <div class="info-card">
      <label>Categoría</label>
      <div class="info-value">{{ ticket.nombreCategoria }}</div>
    </div>

    <div class="info-card">
      <label>Prioridad</label>
      <div class="info-value priority" [ngClass]="'prioridad-' + ticket.nombrePrioridad.toLowerCase().replace(' ', '')">
        {{ ticket.nombrePrioridad }}
      </div>
    </div>

    <div class="info-card">
      <label>Solicitante</label>
      <div class="info-value">{{ ticket.nombreUsuario }} {{ ticket.apellidoUsuario }}</div>
    </div>
  </div>

  <!-- Descripción Completa -->
  <div class="description-card">
    <h3>Descripción del Problema</h3>
    <p>{{ ticket.descTicket }}</p>
  </div>

  <!-- Agregar Nuevo Comentario -->
  <div class="comment-form-section">
    <h3 class="section-title">Agregar Comentario</h3>
    <div class="comment-form">
      <textarea [(ngModel)]="nuevoComentario" placeholder="Escribe tu comentario aquí..." rows="3"
        class="comment-textarea" [disabled]="enviandoComentario"></textarea>
      <button class="btn-submit-comment" (click)="agregarComentario()"
        [disabled]="!nuevoComentario.trim() || enviandoComentario">
        <span *ngIf="!enviandoComentario">
          <mat-icon>send</mat-icon> Enviar Comentario
        </span>
        <span *ngIf="enviandoComentario">Enviando...</span>
      </button>
    </div>
  </div>

  <!-- Historial del Ticket -->
  <div class="timeline-section">
    <div class="timeline-header">
      <h3 class="timeline-title">Historial de Actividad</h3>

      <!-- Filtros -->
      <div class="filter-buttons">
        <button class="filter-btn" [class.active]="filtroActivo === 'todos'" (click)="cambiarFiltro('todos')">
          Todos
        </button>
        <button class="filter-btn" [class.active]="filtroActivo === 'comentario'" (click)="cambiarFiltro('comentario')">
          Comentarios
        </button>
        <button class="filter-btn" [class.active]="filtroActivo === 'observacion'"
          (click)="cambiarFiltro('observacion')">
          Observaciones
        </button>
        <button class="filter-btn" [class.active]="filtroActivo === 'estado'" (click)="cambiarFiltro('estado')">
          Estado
        </button>
      </div>
    </div>

    <div class="timeline" *ngIf="historialFiltrado.length > 0; else noHistorial">
      <div class="timeline-item" *ngFor="let item of historialFiltrado; let i = index">
        <div class="timeline-date">
          <div class="date-box">
            <div class="month">{{ item.fechaCreacion | date:'MMM' }}</div>
            <div class="day">{{ item.fechaCreacion | date:'dd' }}</div>
          </div>
        </div>

        <div class="timeline-line">
          <div class="timeline-dot"></div>
          <div class="timeline-connector" *ngIf="i < historialFiltrado.length - 1"></div>
        </div>

        <div class="timeline-content">
          <div class="timeline-meta">
            <span class="time">{{ item.fechaCreacion | date:'HH:mm' }}</span>
            <span class="author">{{ item.nombres }} {{ item.apellidos }}</span>
            <span class="role">({{ item.nombreRol }})</span>
          </div>

          <div class="timeline-card">
            <h4 class="timeline-status">{{ getStatusTitle(item.tipo) }}</h4>
            <p class="timeline-description">{{ item.contenido }}</p>

            <!-- Archivos Adjuntos -->
            <div class="attachments" *ngIf="item.adjunto">
              <div class="attachment-label"><mat-icon>attach_file</mat-icon> Adjuntos:</div>
              <div class="attachment-list">
                <a *ngFor="let archivo of item.adjunto.split(',')" [href]="'http://localhost:3000/uploads/' + archivo"
                  target="_blank" class="attachment-link">
                  {{ archivo }}
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noHistorial>
      <div class="empty-state">
        <mat-icon>history</mat-icon>
        <p>No hay actividad registrada con este filtro.</p>
      </div>
    </ng-template>
  </div>

  <!-- Herramientas -->
  <div class="det-card" *ngIf="herramientas.length > 0">
    <h3><mat-icon>build</mat-icon> Herramientas Utilizadas</h3>
    <ul class="herr-list">
      <li *ngFor="let h of herramientas">{{ h.herramienta }}</li>
    </ul>
  </div>

  <!-- Acciones de estado -->
  <div class="acciones-footer" *ngIf="rolUsuario === 'tecnico' || rolUsuario === 'admin'">
    <button class="btn-action btn-pend" (click)="cambiarEstado(3)">
      <mat-icon>schedule</mat-icon> Marcar Pendiente
    </button>
    <button class="btn-action btn-res" (click)="cambiarEstado(4)">
      <mat-icon>check_circle</mat-icon> Marcar Resuelto
    </button>
    <button class="btn-action btn-cerr" (click)="cambiarEstado(0)">
      <mat-icon>lock</mat-icon> Cerrar Ticket
    </button>
  </div>

</div>

<div *ngIf="loading" class="loading-state">
  <mat-icon class="spin">refresh</mat-icon>
  <span>Cargando detalles...</span>
</div>