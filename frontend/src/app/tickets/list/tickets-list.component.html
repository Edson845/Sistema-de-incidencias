<div class="tickets-container">
  <h2>Gesti√≥n de Tickets</h2>

  <!-- üîπ Controles superiores -->
  <div class="top-bar">
    <!-- Bot√≥n agregar -->
    <button class="btn-agregar" (click)="crearTicket()">‚ûï Nuevo Ticket</button>

    <!-- Barra de b√∫squeda -->
    <input
      type="text"
      [(ngModel)]="filtro"
      placeholder="üîç Buscar..."
      class="search-input"
      (input)="filtrarTickets()"
    />
    <select *ngIf="rolUsuario === 'admin'" class="order-select" [(ngModel)]="ordenSeleccionado" (change)="ordenarTickets()">
      <option value="">Ordenar por...</option>
      <option value="prioridad">Prioridad</option>
      <option value="fecha">Fecha</option>
      <option value="estado">Estado</option>
    </select>
  </div>

  <!-- Indicadores de carga o error -->
  <div *ngIf="loading" class="mensaje info">Cargando tickets...</div>
  <div *ngIf="error" class="mensaje error">{{ error }}</div>

  <!-- Tabla de tickets -->
  <div *ngIf="!loading && ticketsFiltrados.length > 0" class="tabla-responsive">
    <table class="tickets-tabla">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Descripci√≥n</th>
          <th>Asignado A</th>
          <th>Fecha Creaci√≥n</th>
          <th>Categor√≠a</th>
          <th>Estado</th>
          <th *ngIf="rolUsuario === 'admin'">Prioridad</th>
          <th *ngIf="rolUsuario === 'admin'">Usuario</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let t of ticketsFiltrados">
          <td>{{ t.tituloTicket }}</td>
          <td>{{ t.descTicket }}</td>
          <td>{{t.nombreTecnico ? (t.nombreTecnico + ' ' + t.apellidoTecnico): 'Sin asignar'}}</td>
          <td>{{ t.fechaCreacion | date:'dd/MM/yyyy HH:mm'}}</td>
          <td>{{ t.nombreCategoria }}</td>
          <td>
            <span
              [ngClass]="{
                'estado-nuevo': t.idEstado == 1,
                'estado-abierto': t.idEstado == 2,
                'estado-pendiente': t.idEstado == 3,
                'estado-resuelto': t.idEstado == 4,
                'estado-cerrado': t.idEstado == 5
              }"
            >
              {{
                t.idEstado == 1 ? 'Nuevo' :
                t.idEstado == 2 ? 'Abierto' :
                t.idEstado == 3 ? 'Pendiente' :
                t.idEstado == 4 ? 'Resuelto' :
                t.idEstado == 5 ? 'Cerrado':
                'desconocido'
              }}
            </span>
          </td>
          <td *ngIf="rolUsuario === 'admin'">
            <span
              [ngClass]="{
                'prioridad-muybaja': t.nombrePrioridad == 'Muy Baja',
                'prioridad-baja': t.nombrePrioridad == 'Baja',
                'prioridad-media': t.nombrePrioridad == 'Media',
                'prioridad-alta': t.nombrePrioridad == 'Alta',
                'prioridad-muyalta': t.nombrePrioridad == 'Muy Alta'
              }"
            >
              {{ t.nombrePrioridad }}
            </span>
          </td>
          <td *ngIf="rolUsuario === 'admin'">{{ t.nombreUsuario }} {{ t.apellidoUsuario }}</td>

          <!-- Acciones -->
          <td>
            <button class="btn-ver" (click)="verTicket(t.idTicket)">üëÅ Ver</button>
            <!-- Bot√≥n Asignar solo para admin -->
            <button
              *ngIf="rolUsuario === 'admin' && !t.asignadoA"
              class="btn-asignar"
              (click)="asignarTicket(t.idTicket)"
            >
              üõ† Asignar
            </button>
            <button  *ngIf="rolUsuario === 'usuario' && t.idEstado === 4" class="btn-editar" 
            mat-flat-button color="accent" (click)="abrirEvaluacion(t.idTicket)">Calificar</button>
            
            <button  *ngIf="rolUsuario === 'tecnico' && t.idEstado == 2" class="btn-editar" 
            (click)="solucionarTicket(t.idTicket)">Solucionar</button>

            <button  *ngIf="rolUsuario === 'tecnico' && t.idEstado === 3" class="btn-editar" 
            (click)="abrirEvaluacion(t.idTicket)">Cerrar</button>
             
          </td>
        </tr>
      </tbody>
    </table>
  </div>

 
  