<div class="tickets-container">
  <h2>Gesti√≥n de Tickets</h2>

  <!-- üîπ Controles superiores -->
  <div class="top-bar">
    <!-- Bot√≥n agregar -->
    <button class="btn-agregar" (click)="crearTicket()">‚ûï Nuevo Ticket</button>

    <!-- Barra de b√∫squeda -->
    <input
      type="text"
      [(ngModel)]="filtro"
      placeholder="üîç Buscar..."
      class="search-input"
      (input)="filtrarTickets()"
    />
    <select *ngIf="rolUsuario === 'admin'" class="order-select" [(ngModel)]="ordenSeleccionado" (change)="ordenarTickets()">
      <option value="">Ordenar por...</option>
      <option value="prioridad">Prioridad</option>
      <option value="fecha">Fecha</option>
      <option value="estado">Estado</option>
    </select>
  </div>

  <!-- Indicadores de carga o error -->
  <div *ngIf="loading" class="mensaje info">Cargando tickets...</div>
  <div *ngIf="error" class="mensaje error">{{ error }}</div>

  <!-- Tabla de tickets -->
  <div *ngIf="!loading && ticketsFiltrados.length > 0" class="tabla-responsive">
    <table class="tickets-tabla">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Descripci√≥n</th>
          <th>Asignado A</th>
          <th>Fecha Creaci√≥n</th>
          <th>Categor√≠a</th>
          <th>Estado</th>
          <th *ngIf="rolUsuario === 'admin'">Prioridad</th>
          <th *ngIf="rolUsuario === 'admin'">Usuario</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let t of ticketsFiltrados">
          <td>{{ t.tituloTicket }}</td>
          <td>{{ t.descTicket }}</td>
          <td>{{t.nombreTecnico ? (t.nombreTecnico + ' ' + t.apellidoTecnico): 'Sin asignar'}}</td>
          <td>{{ t.fechaCreacion | date:'dd/MM/yyyy HH:mm'}}</td>
          <td>{{ t.nombreCategoria }}</td>
          <td>
            <span
              [ngClass]="{
                'estado-nuevo': t.idEstado == 1,
                'estado-abierto': t.idEstado == 2,
                'estado-pendiente': t.idEstado == 3,
                'estado-resuelto': t.idEstado == 4,
                'estado-cerrado': t.idEstado == 0
              }"
            >
              {{
                t.idEstado == 1 ? 'Nuevo' :
                t.idEstado == 2 ? 'Abierto' :
                t.idEstado == 3 ? 'Pendiente' :
                t.idEstado == 4 ? 'Resuelto' :
                'Cerrado'
              }}
            </span>
          </td>
          <td *ngIf="rolUsuario === 'admin'">
            <span
              [ngClass]="{
                'prioridad-baja': t.nombrePrioridad == 'Baja',
                'prioridad-media': t.nombrePrioridad == 'Media',
                'prioridad-alta': t.nombrePrioridad == 'Alta',
                'prioridad-muyalta': t.nombrePrioridad == 'Muy Alta'
              }"
            >
              {{ t.nombrePrioridad }}
            </span>
          </td>
          <td *ngIf="rolUsuario === 'admin'">{{ t.nombreUsuario }} {{ t.apellidoUsuario }}</td>

          <!-- Acciones -->
          <td>
            <button class="btn-ver" (click)="verTicket(t.idTicket)">üëÅ Ver</button>
            <!-- Bot√≥n Asignar solo para admin -->
            <button
              *ngIf="rolUsuario === 'admin' && !t.asignadoA"
              class="btn-asignar"
              (click)="asignarTicket(t.idTicket)"
            >
              üõ† Asignar
            </button>
            <button  *ngIf="rolUsuario === 'admin'" class="btn-editar" 
            (click)="editarTicket(t.idTicket)">‚úèÔ∏è Editar</button>

          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="modal-overlay" *ngIf="mostrarModalAsignar">
  <div class="modal">

    <h3>Asignar Ticket</h3>

    <!-- PESTA√ëAS -->
    <div class="tabs">
      <button 
        [class.active]="tabSeleccionada === 'tecnico'"
        (click)="tabSeleccionada = 'tecnico'">
        T√©cnico
      </button>

      <button 
        [class.active]="tabSeleccionada === 'herramientas'"
        (click)="tabSeleccionada = 'herramientas'">
        Herramientas
      </button>
    </div>

    <!-- ‚úÖ TAB T√âCNICO -->
    <div *ngIf="tabSeleccionada === 'tecnico'" class="tab-content">

      <label>Buscar t√©cnico:</label>
      <input 
        type="text"
        [(ngModel)]="filtroTecnico"
        placeholder="Escribe nombre o apellido..."
        (input)="filtrarTecnicos()"
        class="input-buscar"
      />

      <label>Selecciona un t√©cnico:</label>
      <select [(ngModel)]="tecnicoSeleccionado">
      <option *ngFor="let t of tecnicosFiltrados" [value]="t.dni">
          {{ t.nombres }} {{ t.apellidos }}
        </option>
      </select>
    </div>

    <!-- ‚úÖ TAB HERRAMIENTAS -->
    <div *ngIf="tabSeleccionada === 'herramientas'" class="tab-content">
      <div class="herramientas-list">
        <div *ngFor="let h of herramientasFiltradas">
          <input type="checkbox"
                 [checked]="herramientasSeleccionadas.includes(h)"
                 (change)="toggleHerramienta(h)">
          {{ h }}
        </div>
      </div>

      <!-- ‚úÖ AGREGAR NUEVA HERRAMIENTA -->
      <div class="agregar-herramienta">
        <input 
          type="text"
          [(ngModel)]="nuevaHerramienta"
          placeholder="Nueva herramienta..."
        />
        <button (click)="agregarHerramienta()">‚ûï</button>
      </div>

    </div>

    <!-- ‚úÖ Botones -->
    <div class="modal-buttons">
      <button class="btn-confirm"
              (click)="confirmarAsignacion(tecnicoSeleccionado)">
        ‚úÖ Asignar
      </button>

      <button class="btn-cancelar" (click)="mostrarModalAsignar = false">
        ‚ùå Cancelar
      </button>
    </div>

  </div>
</div>



  <!-- Mensaje si no hay tickets -->
  <div *ngIf="!loading && ticketsFiltrados.length === 0" class="mensaje vacio">
    No se encontraron tickets.
  </div>
</div>
